<!DOCTYPE html>
<html>
<head>
    <title>ICCP Iqama Times Widget</title>
</head>
<body>
    <script>
        (function() {
            // ========================================
            // ICCP IQAMA TIMES WIDGET
            // ========================================
            // A beautiful, responsive prayer times widget for ICCP
            // Fetches data from Google Sheets and displays current/next prayer status
            // ========================================
            
            // Google Sheets Configuration
            const SHEET_ID = '14yebmqPkLo0fT0GdlXW1vq0Y4jZsYtNgbK3ijTAIQlU';
            const SHEET_NAME = 'Sheet1';
            let prayerTimesData = [];
            

            
            // ========================================
            // DATA FETCHING FUNCTIONS
            // ========================================
            
            /**
             * Fetches prayer times from Google Sheets
             * Tries multiple endpoints for compatibility
             * @returns {Promise<void>}
             */
            async function fetchPrayerTimes() {
                try {
                    // Try multiple approaches to fetch data
                    let csvText = '';
                    
                    // Method 1: Try Google Visualization API (most reliable)
                    try {
                        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;
                        const response = await fetch(url, {
                            mode: 'cors'
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        csvText = await response.text();
                    } catch (e) {
                        // Method 2: Try direct CSV export
                        try {
                            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv`;
                            const response = await fetch(url, {
                                mode: 'cors'
                            });
                            
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                            
                            csvText = await response.text();
                        } catch (e2) {
                            throw new Error('Both methods failed');
                        }
                    }
                    
                    // Parse CSV data
                    const lines = csvText.split('\n');
                    
                    prayerTimesData = [];
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            // Handle quoted CSV values properly
                            const values = lines[i].split(',').map(value => {
                                // Remove quotes and trim
                                return value.replace(/^"/, '').replace(/"$/, '').trim();
                            });
                            
                            if (values.length >= 8) {
                                prayerTimesData.push({
                                    month: parseInt(values[0]),
                                    day: parseInt(values[1]),
                                    fajr: values[2],
                                    dhuhr: values[3],  // Zuhr is now at position 3
                                    asr: values[4],    // Asr moved to position 4
                                    maghrib: values[5], // Maghrib moved to position 5
                                    isha: values[6],    // Isha moved to position 6
                                    jumuah: values[7]  // Jumuah moved to position 7
                                });
                            }
                        }
                    }
                    
                    console.log('âœ… Prayer times loaded successfully:', prayerTimesData.length, 'days');
                    if (prayerTimesData.length > 0) {
                        console.log('ðŸ“… Today\'s prayer times:', getPrayerTimesForToday());
                    }
                    createWidget();
                } catch (error) {
                    console.error('Error fetching prayer times:', error);
                    console.log('Using fallback times...');
                    
                    // Fallback to default times if fetch fails
                    prayerTimesData = [{
                        month: 1,
                        day: 1,
                        fajr: "5:30 AM",
                        zuhr: "1:30 PM",
                        jumuah: "1:00 PM",
                        asr: "4:45 PM",
                        maghrib: "7:15 PM",
                        isha: "8:45 PM"
                    }];
                    createWidget();
                }
            }
            
            // Get prayer times for current date and next day if needed
            function getPrayerTimesForToday() {
                const today = new Date();
                const currentMonth = today.getMonth() + 1; // JavaScript months are 0-indexed
                const currentDay = today.getDate();
                
                // Find matching prayer times for today
                const todayData = prayerTimesData.find(row => 
                    row.month === currentMonth && row.day === currentDay
                );
                
                // Find matching prayer times for tomorrow
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowMonth = tomorrow.getMonth() + 1;
                const tomorrowDay = tomorrow.getDate();
                
                const tomorrowData = prayerTimesData.find(row => 
                    row.month === tomorrowMonth && row.day === tomorrowDay
                );
                
                if (todayData) {
                    return {
                        fajr: todayData.fajr,
                        dhuhr: todayData.dhuhr,
                        jumuah: todayData.jumuah,
                        asr: todayData.asr,
                        maghrib: todayData.maghrib,
                        isha: todayData.isha,
                        // Add tomorrow's Fajr for next-day calculations
                        tomorrowFajr: tomorrowData?.fajr || todayData.fajr
                    };
                }
                
                // Fallback to first row if today not found
                return {
                    fajr: prayerTimesData[0]?.fajr || "5:30 AM",
                    dhuhr: prayerTimesData[0]?.dhuhr || "1:30 PM",
                    jumuah: prayerTimesData[0]?.jumuah || "1:00 PM",
                    asr: prayerTimesData[0]?.asr || "4:45 PM",
                    maghrib: prayerTimesData[0]?.maghrib || "7:15 PM",
                    isha: prayerTimesData[0]?.isha || "8:45 PM",
                    tomorrowFajr: prayerTimesData[0]?.fajr || "5:30 AM"
                };
            }

            // Get current time to determine next prayer
            function getCurrentTime() {
                const now = new Date();
                return now.getHours() * 60 + now.getMinutes(); // Convert to minutes
            }

            function timeToMinutes(timeStr) {
                if (!timeStr || typeof timeStr !== 'string') {
                    console.error('Invalid time string:', timeStr);
                    return 0;
                }
                
                const [time, period] = timeStr.split(' ');
                if (!time || !period) {
                    console.error('Invalid time format:', timeStr);
                    return 0;
                }
                
                const [hours, minutes] = time.split(':').map(Number);
                if (isNaN(hours) || isNaN(minutes)) {
                    console.error('Invalid time numbers:', timeStr);
                    return 0;
                }
                
                let totalMinutes = hours * 60 + minutes;
                
                if (period === 'PM' && hours !== 12) totalMinutes += 12 * 60;
                if (period === 'AM' && hours === 12) totalMinutes = minutes;
                
                return totalMinutes;
            }

            /**
             * Determines current and next prayer status based on current time
             * Implements 30-minute window for "current prayer" and Friday logic
             * @param {Object} iqamaTimes - Object containing prayer times
             * @returns {Object} Status object with current, next, status, and nextTime
             */
            function getPrayerStatus(iqamaTimes) {
                if (!iqamaTimes || typeof iqamaTimes !== 'object') {
                    return { current: null, next: 'fajr', status: 'next', nextTime: '5:30 AM' };
                }
                
                const currentTime = getCurrentTime();
                const now = new Date();
                const isFriday = now.getDay() === 5; // Friday is day 5 (0 = Sunday)
                
                // Define prayer order - on Friday, replace Dhuhr with Jumuah
                let prayerOrder = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'];
                if (isFriday) {
                    prayerOrder = ['fajr', 'jumuah', 'asr', 'maghrib', 'isha'];
                }
                const prayerTimes = {};
                
                // Convert all prayer times to minutes for comparison
                for (let [prayer, time] of Object.entries(iqamaTimes)) {
                    if (prayerOrder.includes(prayer)) {
                        prayerTimes[prayer] = timeToMinutes(time);
                    }
                }
                
                // Check for current prayer (within 30-minute window)
                let currentPrayer = null;
                for (let prayer of prayerOrder) {
                    const prayerTime = prayerTimes[prayer];
                    // Check if current time is within 30 minutes after prayer time
                    if (currentTime >= prayerTime && currentTime <= (prayerTime + 30)) {
                        currentPrayer = prayer;
                        break;
                    }
                }
                
                // If we have a current prayer, show it
                if (currentPrayer) {
                    return {
                        current: currentPrayer,
                        next: currentPrayer,
                        status: 'current',
                        nextTime: iqamaTimes[currentPrayer]
                    };
                }
                
                // Find next prayer (closest upcoming)
                let nextPrayer = null;
                let shortestTimeDiff = Infinity;
                let nextTime = '';
                
                for (let prayer of prayerOrder) {
                    const prayerTime = prayerTimes[prayer];
                    let timeDiff = prayerTime - currentTime;
                    
                    // If this prayer is closer than the current closest
                    if (timeDiff > 0 && timeDiff < shortestTimeDiff) {
                        shortestTimeDiff = timeDiff;
                        nextPrayer = prayer;
                        nextTime = iqamaTimes[prayer];
                    }
                }
                
                // If no next prayer found today, next is Fajr (tomorrow)
                if (!nextPrayer) {
                    nextPrayer = 'fajr';
                    // Use tomorrow's Fajr time if available, otherwise use today's
                    nextTime = iqamaTimes.tomorrowFajr || iqamaTimes.fajr;
                }
                
                return {
                    current: null,
                    next: nextPrayer,
                    status: 'next',
                    nextTime: nextTime
                };
            }

            // Create and inject the widget
            /**
             * Creates and displays the main prayer times widget
             * Handles prayer status, current/next prayer highlighting, and layout
             */
            function createWidget() {
                const iqamaTimes = getPrayerTimesForToday();
                const prayerStatus = getPrayerStatus(iqamaTimes);
                const currentPrayer = prayerStatus.current;
                const nextPrayer = prayerStatus.next;
                const isCurrentPrayer = prayerStatus.status === 'current';
                const statusText = isCurrentPrayer ? 'Current Prayer' : 'Next Prayer';
                const nextPrayerTime = prayerStatus.nextTime;
                
                // Get date info for next-day prayers
                const currentDate = new Date();
                const currentTime = getCurrentTime();
                
                // Check if all of today's prayers have passed (after Isha's 30-minute window)
                const isFriday = currentDate.getDay() === 5;
                let prayerOrder = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'];
                if (isFriday) {
                    prayerOrder = ['fajr', 'jumuah', 'asr', 'maghrib', 'isha'];
                }
                
                // Check if we're past all of today's prayers
                const allPrayersPassed = prayerOrder.every(prayer => {
                    const prayerTime = timeToMinutes(iqamaTimes[prayer]);
                    return currentTime > (prayerTime + 30); // 30 minutes after prayer time
                });
                
                // Only show tomorrow's date if all prayers have passed AND next prayer is Fajr
                const isNextDayFajr = !isCurrentPrayer && nextPrayer === 'fajr' && allPrayersPassed;
                
                const tomorrowDate = new Date(currentDate);
                tomorrowDate.setDate(tomorrowDate.getDate() + 1);
                const tomorrowFormatted = tomorrowDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                const widgetHTML = `
                    <style>
                        @keyframes pulse {
                            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                            50% { transform: translate(-50%, -50%) scale(1.5); opacity: 0.7; }
                            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                        }
                        
                        @keyframes float {
                            0%, 100% { transform: translateY(0px); }
                            50% { transform: translateY(-3px); }
                        }
                        
                        #iqama-widget {
                            animation: float 6s ease-in-out infinite;
                            position: relative !important;
                            z-index: 9999 !important;
                            margin: 20px auto !important;
                            display: block !important;
                            clear: both !important;
                        }
                        
                        /* Enhanced Visual Hierarchy & Polish */
                        .next-prayer-glow {
                            animation: nextPrayerGlow 2s ease-in-out infinite alternate;
                        }
                        
                        .current-prayer-glow {
                            animation: currentPrayerGlow 1.5s ease-in-out infinite alternate;
                        }
                        
                        @keyframes nextPrayerGlow {
                            0% { 
                                box-shadow: 0 0 20px rgba(212, 175, 55, 0.4),
                                           0 0 40px rgba(212, 175, 55, 0.2),
                                           0 0 60px rgba(212, 175, 55, 0.1);
                            }
                            100% { 
                                box-shadow: 0 0 30px rgba(212, 175, 55, 0.6),
                                           0 0 60px rgba(212, 175, 55, 0.3),
                                           0 0 90px rgba(212, 175, 55, 0.15);
                            }
                        }
                        
                        @keyframes currentPrayerGlow {
                            0% { 
                                box-shadow: 0 0 25px rgba(255, 107, 107, 0.5),
                                           0 0 50px rgba(255, 142, 83, 0.3),
                                           0 0 75px rgba(255, 107, 107, 0.2);
                            }
                            100% { 
                                box-shadow: 0 0 35px rgba(255, 107, 107, 0.7),
                                           0 0 70px rgba(255, 142, 83, 0.4),
                                           0 0 105px rgba(255, 107, 107, 0.25);
                            }
                        }
                        
                        .prayer-item:hover {
                            transform: translateY(-2px);
                            transition: transform 0.3s ease;
                        }
                        
                        .time-circle:hover {
                            transform: scale(1.05);
                            transition: transform 0.3s ease;
                        }
                        
                        .enhanced-shadow {
                            box-shadow: 
                                0 8px 32px rgba(0, 0, 0, 0.3),
                                0 4px 16px rgba(0, 0, 0, 0.2),
                                0 2px 8px rgba(0, 0, 0, 0.1);
                        }
                        
                        /* Minimal Squarespace positioning - preserve design */
                        .sqs-block.code-block .sqs-block-content {
                            position: relative !important;
                            overflow: visible !important;
                        }
                        
                        /* Ensure widget stays in place without breaking design */
                        #iqama-widget {
                            position: relative !important;
                            display: block !important;
                            width: 100% !important;
                            max-width: 450px !important;
                            margin: 20px auto !important;
                        }
                        }
                        
                        /* Override any Squarespace positioning */
                        /* Clean, minimal positioning - preserve design */
                        .sqs-code-block-wrapper {
                            position: relative !important;
                            display: block !important;
                            width: 100% !important;
                            max-width: 450px !important;
                            margin: 20px auto !important;
                        }
                        
                        .refined-border {
                            background-image: 
                                linear-gradient(45deg, #D4AF37 25%, transparent 25%),
                                linear-gradient(-45deg, #D4AF37 25%, transparent 25%),
                                linear-gradient(45deg, transparent 75%, #D4AF37 75%),
                                linear-gradient(-45deg, transparent 75%, #D4AF37 75%);
                            background-size: 8px 8px;
                            background-position: 0 0, 0 4px, 4px -4px, -4px 0px;
                        }
                        
                        .section-divider {
                            height: 2px;
                            background: linear-gradient(90deg, transparent, #D4AF37, transparent);
                            margin: 25px 0;
                            opacity: 0.6;
                        }
                        
                        /* Mobile-first responsive design - consistent spacing and centering */
                        @media (max-width: 480px) {
                            #iqama-widget {
                                max-width: 95vw;
                                margin: 20px auto;
                                border-radius: 15px;
                                text-align: center;
                                padding: 25px 20px;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                            }
                            
                            /* Consistent spacing system */
                            .prayer-row {
                                flex-direction: column;
                                gap: 25px;
                                margin-bottom: 25px;
                                align-items: center;
                                width: 100%;
                            }
                            
                            .prayer-item {
                                width: 100%;
                                max-width: 200px;
                                margin: 0 auto 25px auto;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                justify-content: flex-start;
                                padding: 20px 15px;
                                position: relative;
                                text-align: center;
                                min-height: 120px;
                            }
                            
                            .time-circle {
                                width: 70px;
                                height: 70px;
                                margin: 0 auto 20px auto;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                flex-shrink: 0;
                            }
                            
                            .prayer-name {
                                font-size: 20px;
                                text-align: center;
                                width: 100%;
                                margin-bottom: 15px;
                                line-height: 1.2;
                                display: block;
                                font-weight: 600;
                            }
                            
                            .prayer-time {
                                font-size: 18px;
                                text-align: center;
                                width: 100%;
                                margin: 0;
                                line-height: 1.3;
                                display: block;
                                font-weight: 500;
                            }
                            

                            
                            .jumuah-section {
                                max-width: 90%;
                                padding: 30px 25px;
                                margin: 30px auto;
                                text-align: center;
                                border-radius: 20px;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                width: 100%;
                            }
                            
                            .jumuah-time-circle {
                                width: 80px;
                                height: 80px;
                                margin: 0 auto 25px auto;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                flex-shrink: 0;
                            }
                            
                            .header-content {
                                padding: 30px 25px 25px;
                                text-align: center;
                                margin-bottom: 30px;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                width: 100%;
                            }
                            
                            .date-display {
                                font-size: 20px;
                                margin-bottom: 20px;
                                text-align: center;
                                width: 100%;
                                line-height: 1.3;
                                display: block;
                                font-weight: 500;
                            }
                            
                            .title-text {
                                font-size: 28px;
                                margin-bottom: 20px;
                                text-align: center;
                                width: 100%;
                                line-height: 1.2;
                                display: block;
                                font-weight: 700;
                            }
                            
                            .location-text {
                                font-size: 22px;
                                margin-bottom: 25px;
                                text-align: center;
                                width: 100%;
                                line-height: 1.3;
                                display: block;
                                font-weight: 500;
                            }
                            
                            .logo-mobile {
                                width: 50px;
                                height: 50px;
                                top: 20px;
                                right: 20px;
                                position: absolute;
                                z-index: 10;
                                pointer-events: none;
                                flex-shrink: 0;
                                object-fit: contain;
                                max-width: 50px;
                                max-height: 50px;
                                min-width: 50px;
                                min-height: 50px;
                            }
                            
                            /* Prevent overlapping elements */
                            .status-badge {
                                position: absolute;
                                top: 10px;
                                left: 10px;
                                z-index: 5;
                                pointer-events: none;
                                flex-shrink: 0;
                                object-fit: contain;
                                width: auto;
                                height: auto;
                            }
                            
                            /* Consistent section spacing */
                            .section-divider {
                                margin: 30px 0;
                                height: 3px;
                                width: 80%;
                                max-width: 200px;
                            }
                            
                            /* Ensure all elements are centered */
                            #iqama-widget * {
                                box-sizing: border-box;
                            }
                            
                            /* Force center alignment for all text */
                            .prayer-item p,
                            .prayer-item span,
                            .prayer-item div,
                            .prayer-item h3,
                            .prayer-item h4 {
                                text-align: center !important;
                                width: 100% !important;
                                margin-left: auto !important;
                                margin-right: auto !important;
                            }
                            

                            
                            /* Consistent button and interactive element spacing */
                            .prayer-item button,
                            .prayer-item .status-badge {
                                margin: 0 auto;
                                display: block;
                            }
                        }
                        
                        /* Extra small mobile devices (360px-390px) - consistent spacing */
                        @media (max-width: 390px) {
                            #iqama-widget {
                                max-width: 98vw;
                                margin: 15px auto;
                                padding: 20px 15px;
                            }
                            
                            .prayer-item {
                                max-width: 180px;
                                margin-bottom: 40px;
                                padding: 15px 10px;
                                min-height: 140px;
                            }
                            
                            .prayer-row {
                                gap: 20px;
                                margin-bottom: 40px;
                            }
                            
                            .time-circle {
                                width: 60px;
                                height: 60px;
                                margin-bottom: 15px;
                            }
                            
                            .jumuah-time-circle {
                                width: 70px;
                                height: 70px;
                                margin-bottom: 20px;
                            }
                            
                            .title-text {
                                font-size: 24px;
                                margin-bottom: 15px;
                            }
                            
                            .date-display {
                                font-size: 18px;
                                margin-bottom: 15px;
                            }
                            
                            .header-content {
                                padding: 25px 20px 20px;
                                margin-bottom: 25px;
                            }
                            
                            .jumuah-section {
                                padding: 25px 20px;
                                margin: 25px auto;
                            }
                            
                            /* Perfect consistent spacing for all prayer items on mobile */
                            .prayer-item {
                                margin-bottom: 40px !important;
                            }
                            
                            /* Remove extra spacing from prayer rows on mobile */
                            .prayer-row {
                                gap: 0 !important;
                                margin-bottom: 0 !important;
                            }
                            
                            .section-divider {
                                margin: 25px 0;
                            }
                            
                            /* Full Schedule Button Mobile Styling */
                            a[href*='docs.google.com'] {
                                font-size: 16px !important;
                                padding: 12px 24px !important;
                                width: 90% !important;
                                max-width: 300px !important;
                            }
                            
                            .prayer-name {
                                font-size: 18px;
                                margin-bottom: 12px;
                            }
                            
                            .prayer-time {
                                font-size: 16px;
                            }
                        }
                        
                        @media (max-width: 768px) and (min-width: 481px) {
                            #iqama-widget {
                                max-width: 90vw;
                                margin: 15px auto;
                            }
                            
                            .prayer-row {
                                gap: 15px;
                            }
                            
                            .prayer-item {
                                max-width: 120px;
                            }
                        }
                        
                        @media (min-width: 769px) {
                            #iqama-widget {
                                max-width: 450px !important;
                                margin: 20px auto !important;
                            }
                        }
                    </style>
                    
                    <div class="sqs-code-block-wrapper" style="position: relative !important; overflow: visible !important;">
                    <div id="iqama-widget" class="enhanced-shadow iqama-widget-container" style="
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        max-width: 450px;
                        margin: 20px auto;
                        background: linear-gradient(135deg, #0F4C3A 0%, #1A5F4A 50%, #0F4C3A 100%);
                        border-radius: 20px;
                        overflow: hidden;
                        border: 2px solid #D4AF37;
                        position: relative;
                    ">
                        <!-- Enhanced geometric border pattern -->
                        <div class="refined-border" style="
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            opacity: 0.12;
                            pointer-events: none;
                        "></div>
                        
                        <!-- Header Section -->
                        <div class="header-content" style="
                            padding: 25px 20px 20px;
                            text-align: center;
                            position: relative;
                            z-index: 2;
                        ">
                            <!-- Date Display -->
                            <div class="date-display" style="
                                color: #D4AF37;
                                font-size: 22px;
                                font-weight: 500;
                                margin-bottom: 15px;
                                letter-spacing: 1px;
                                opacity: 0.9;
                                text-transform: uppercase;
                            ">${new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</div>
                            
                            <!-- Title -->
                            <div style="
                                color: #D4AF37;
                                margin-bottom: 20px;
                            ">
                                <span class="title-text" style="
                                    font-size: 44px;
                                    font-weight: 800;
                                    font-family: 'Georgia', serif;
                                    text-shadow: 0 3px 6px rgba(0,0,0,0.4);
                                    letter-spacing: 1px;
                                ">Prayer Times</span>
                            </div>
                            
                            <!-- Location -->
                            <div class="location-text" style="
                                color: #D4AF37;
                                font-size: 28px;
                                font-weight: 600;
                                margin-bottom: 25px;
                                letter-spacing: 1.5px;
                                opacity: 0.95;
                            ">ICCP AZ</div>
                            
                            <!-- ICCP Logo in Top Right Corner -->
                            <img src="https://drive.google.com/thumbnail?id=10TLPa628wzYPFAax-VsHhlM8qKNzevk2&sz=w120" 
                                 class="logo-mobile"
                                 style="
                                    position: absolute;
                                    top: 20px;
                                    right: 20px;
                                    width: 60px;
                                    height: 60px;
                                    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
                                    mix-blend-mode: multiply;
                                    opacity: 0.6;
                                 "
                                 alt="ICCP Logo">
                        </div>

                        <!-- Prayer Times Display -->
                        <div style="
                            padding: 25px;
                            position: relative;
                            z-index: 2;
                        ">
                            <!-- Top Row: Fajr, Zuhr, Jumuah, Asr -->
                            <div class="prayer-row" style="
                                display: flex;
                                justify-content: space-around;
                                margin-bottom: 30px;
                                gap: 20px;
                            ">
                                ${['fajr', 'dhuhr', 'asr'].map(prayer => {
                                    const isCurrent = prayer === currentPrayer && isCurrentPrayer;
                                    const prayerNames = { fajr: 'Fajr', dhuhr: 'Zuhr', asr: 'Asr' };
                                    const [time, period] = iqamaTimes[prayer].split(' ');
                                    
                                    return `
                                        <div class="prayer-item" style="
                                            text-align: center;
                                            position: relative;
                                            margin-bottom: 40px;
                                        ">
                                            <!-- Prayer Name -->
                                            <div style="
                                                color: #D4AF37;
                                                font-size: 28px;
                                                font-weight: 700;
                                                margin-bottom: 20px;
                                                letter-spacing: 0.8px;
                                            ">${prayerNames[prayer]}</div>
                                            
                                            <!-- Time Circle -->
                                            <div class="${isCurrent ? 'current-prayer-glow' : ''}" style="
                                                width: 100px;
                                                height: 100px;
                                                border: 3px solid #D4AF37;
                                                border-radius: 50%;
                                                display: flex;
                                                flex-direction: column;
                                                justify-content: center;
                                                align-items: center;
                                                background: ${isCurrent ? 'rgba(212, 175, 55, 0.1)' : 'transparent'};
                                                box-shadow: ${isCurrent ? '0 0 20px rgba(212, 175, 55, 0.3)' : 'none'};
                                                position: relative;
                                            ">
                                                <div style="
                                                    color: #D4AF37;
                                                    font-size: 32px;
                                                    font-weight: 800;
                                                    font-family: 'Courier New', monospace;
                                                    line-height: 1;
                                                ">${time}</div>
                                                <div style="
                                                    color: #D4AF37;
                                                    font-size: 18px;
                                                    font-weight: 600;
                                                    text-transform: uppercase;
                                                    letter-spacing: 0.8px;
                                                    margin-top: 5px;
                                                ">${period.toLowerCase()}</div>
                                                ${isCurrent ? `
                                                    <div style="
                                                        position: absolute;
                                                        top: -8px;
                                                        right: -8px;
                                                        width: 32px;
                                                        height: 20px;
                                                        background: linear-gradient(135deg, #FF6B6B, #FF8E53);
                                                        border-radius: 10px;
                                                        display: flex;
                                                        align-items: center;
                                                        justify-content: center;
                                                        font-size: 8px;
                                                        color: #0F4C3A;
                                                        font-weight: 700;
                                                        letter-spacing: 0.5px;
                                                        border: 2px solid #0F4C3A;
                                                        box-shadow: 0 0 10px rgba(212, 175, 55, 0.4);
                                                    ">NOW</div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            
                            <!-- Bottom Row: Maghrib, Isha -->
                            <div class="prayer-row" style="
                                display: flex;
                                justify-content: center;
                                gap: 100px;
                                margin-bottom: 30px;
                            ">
                                ${['maghrib', 'isha'].map(prayer => {
                                    const isCurrent = prayer === currentPrayer && isCurrentPrayer;
                                    const prayerNames = { maghrib: 'Maghrib', isha: 'Isha' };
                                    const [time, period] = iqamaTimes[prayer].split(' ');
                                    
                                    return `
                                        <div class="prayer-item" style="
                                            text-align: center;
                                            position: relative;
                                            margin-bottom: 40px;
                                        ">
                                            <!-- Prayer Name -->
                                            <div style="
                                                color: #D4AF37;
                                                font-size: 28px;
                                                font-weight: 700;
                                                margin-bottom: 20px;
                                                letter-spacing: 0.8px;
                                            ">${prayerNames[prayer]}</div>
                                            
                                            <!-- Time Circle -->
                                            <div class="${isCurrent ? 'current-prayer-glow' : ''}" style="
                                                width: 100px;
                                                height: 100px;
                                                border: 3px solid #D4AF37;
                                                border-radius: 50%;
                                                display: flex;
                                                flex-direction: column;
                                                justify-content: center;
                                                align-items: center;
                                                background: ${isCurrent ? 'rgba(212, 175, 55, 0.1)' : 'transparent'};
                                                box-shadow: ${isCurrent ? '0 0 20px rgba(212, 175, 55, 0.3)' : 'none'};
                                                position: relative;
                                            ">
                                                <div style="
                                                    color: #D4AF37;
                                                    font-size: 32px;
                                                    font-weight: 800;
                                                    font-family: 'Courier New', monospace;
                                                    line-height: 1;
                                                ">${time}</div>
                                                <div style="
                                                    color: #D4AF37;
                                                    font-size: 18px;
                                                    font-weight: 600;
                                                    text-transform: uppercase;
                                                    letter-spacing: 0.8px;
                                                    margin-top: 5px;
                                                ">${period.toLowerCase()}</div>
                                                ${isCurrent ? `
                                                    <div style="
                                                        position: absolute;
                                                        top: -8px;
                                                        right: -8px;
                                                        width: 32px;
                                                        height: 20px;
                                                        background: linear-gradient(135deg, #FF6B6B, #FF8E53);
                                                        border-radius: 10px;
                                                        display: flex;
                                                        align-items: center;
                                                        justify-content: center;
                                                        font-size: 8px;
                                                        color: #0F4C3A;
                                                        font-weight: 700;
                                                        letter-spacing: 0.5px;
                                                        border: 2px solid #0F4C3A;
                                                        box-shadow: 0 0 10px rgba(212, 175, 55, 0.4);
                                                    ">NOW</div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            
                            <!-- Prayer Status Display -->
                            <div style="
                                text-align: center;
                                margin: 20px 0;
                                padding: 15px;
                                background: rgba(212, 175, 55, 0.05);
                                border-radius: 10px;
                                border: 1px solid rgba(212, 175, 55, 0.2);
                            ">
                                <div style="
                                    color: #D4AF37;
                                    font-size: 22px;
                                    font-weight: 700;
                                    text-transform: uppercase;
                                    letter-spacing: 1px;
                                    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
                                ">${statusText}: ${(isCurrentPrayer ? currentPrayer : nextPrayer).charAt(0).toUpperCase() + (isCurrentPrayer ? currentPrayer : nextPrayer).slice(1)} (${nextPrayerTime})${isNextDayFajr ? ` - ${tomorrowFormatted}` : ''}</div>
                            </div>
                        
                        <!-- Section Divider -->
                        <div class="section-divider"></div>
                        
                        <!-- Jumuah Prayer - Special Square Design -->
                            <div class="jumuah-section enhanced-shadow" style="
                                text-align: center;
                                margin-top: 40px;
                                padding: 25px;
                                background: linear-gradient(135deg, rgba(212, 175, 55, 0.08), rgba(212, 175, 55, 0.03));
                                border: 2px solid #D4AF37;
                                border-radius: 18px;
                                max-width: 220px;
                                margin-left: auto;
                                margin-right: auto;
                                position: relative;
                                overflow: hidden;
                            ">
                                <!-- Subtle pattern overlay -->
                                <div style="
                                    position: absolute;
                                    top: 0;
                                    left: 0;
                                    right: 0;
                                    bottom: 0;
                                    opacity: 0.1;
                                    background-image: 
                                        radial-gradient(circle at 20% 20%, #D4AF37 1px, transparent 1px),
                                        radial-gradient(circle at 80% 80%, #D4AF37 1px, transparent 1px);
                                    background-size: 20px 20px;
                                    pointer-events: none;
                                "></div>
                                <!-- Prayer Name - Sleek Design -->
                                <div style="
                                    margin-bottom: 25px;
                                    text-align: center;
                                ">
                                    <div style="
                                        color: #D4AF37;
                                        font-size: 32px;
                                        font-weight: 800;
                                        letter-spacing: 2px;
                                        text-transform: uppercase;
                                        margin-bottom: 8px;
                                        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
                                    ">Jumuah</div>
                                    <div style="
                                        color: #D4AF37;
                                        font-size: 20px;
                                        font-weight: 600;
                                        letter-spacing: 1px;
                                        opacity: 0.9;
                                        font-style: italic;
                                        text-transform: capitalize;
                                    ">Friday Prayer</div>
                                </div>
                                
                                <!-- Time Circle -->
                                <div class="jumuah-time-circle ${currentPrayer === 'jumuah' && isCurrentPrayer ? 'current-prayer-glow' : ''}" style="
                                    width: 120px;
                                    height: 120px;
                                    border: 3px solid #D4AF37;
                                    border-radius: 50%;
                                    display: flex;
                                    flex-direction: column;
                                    justify-content: center;
                                    align-items: center;
                                    background: ${currentPrayer === 'jumuah' && isCurrentPrayer ? 'rgba(212, 175, 55, 0.2)' : 'rgba(212, 175, 55, 0.08)'};
                                    position: relative;
                                    margin: 0 auto;
                                    transition: all 0.3s ease;
                                ">
                                    <div style="
                                        color: #D4AF37;
                                        font-size: 36px;
                                        font-weight: 800;
                                        font-family: 'Courier New', monospace;
                                        line-height: 1;
                                        text-align: center;
                                    ">1:00</div>
                                    <div style="
                                        color: #D4AF37;
                                        font-size: 20px;
                                        font-weight: 600;
                                        text-transform: uppercase;
                                        letter-spacing: 1px;
                                        margin-top: 8px;
                                        text-align: center;
                                    ">pm</div>
                                    ${currentPrayer === 'jumuah' && isCurrentPrayer ? `
                                        <div style="
                                            position: absolute;
                                            top: -12px;
                                            right: -12px;
                                            width: 36px;
                                            height: 24px;
                                            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
                                            border-radius: 12px;
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            font-size: 9px;
                                            color: #0F4C3A;
                                            font-weight: 800;
                                            letter-spacing: 0.5px;
                                            box-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
                                            border: 2px solid #0F4C3A;
                                        ">NOW</div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <!-- View Full Schedule Button -->
                        <div style="
                            text-align: center;
                            margin-top: 30px;
                            padding: 20px;
                        ">
                            <a href="https://docs.google.com/spreadsheets/d/14yebmqPkLo0fT0GdlXW1vq0Y4jZsYtNgbK3ijTAIQlU/edit?usp=sharing" 
                               target="_blank"
                               style="
                                    display: inline-block;
                                    background: linear-gradient(135deg, #D4AF37, #B8860B);
                                    color: #0F4C3A;
                                    padding: 15px 30px;
                                    border-radius: 25px;
                                    text-decoration: none;
                                    font-size: 18px;
                                    font-weight: 700;
                                    letter-spacing: 1px;
                                    text-transform: uppercase;
                                    border: 2px solid #0F4C3A;
                                    box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
                                    transition: all 0.3s ease;
                                    hover: {
                                        transform: translateY(-2px);
                                        box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
                                    }
                               "
                               onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(212, 175, 55, 0.4)'"
                               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(212, 175, 55, 0.3)'"
                            >
                                View Full Iqama Schedule
                            </a>
                        </div>
                    </div>
                </div>
                `;

                // Create a container div and inject the widget
                const container = document.createElement('div');
                container.innerHTML = widgetHTML;
                
                // Check if widget already exists to prevent multiple insertions
                if (document.getElementById('iqama-widget')) {
                    console.log('âš ï¸ Widget already exists, skipping insertion');
                    return;
                }
                
                // Try to find the Code Block that contains this script
                let targetContainer = null;
                const codeBlocks = document.querySelectorAll('.sqs-block.code-block');
                
                // Find the Code Block that contains this script
                for (let block of codeBlocks) {
                    if (block.textContent.includes('iqama-widget')) {
                        targetContainer = block.querySelector('.sqs-block-content');
                        console.log('ðŸŽ¯ Found Code Block containing script');
                        break;
                    }
                }
                
                // If we can't find it, try to find any Code Block
                if (!targetContainer) {
                    targetContainer = document.querySelector('.sqs-block.code-block .sqs-block-content');
                    console.log('ðŸ” Using fallback Code Block');
                }
                
                if (targetContainer) {
                    // Insert into the Code Block
                    targetContainer.appendChild(container);
                    console.log('âœ… Widget inserted into Code Block');
                    
                    // Force it to stay in position by setting explicit styles
                    setTimeout(() => {
                        const widget = document.getElementById('iqama-widget');
                        if (widget) {
                            // Set minimal inline styles for positioning only
                            widget.style.position = 'relative';
                            widget.style.display = 'block';
                            widget.style.width = '100%';
                            widget.style.maxWidth = '450px';
                            widget.style.margin = '20px auto';
                            
                            // Also set minimal styles on the wrapper
                            const wrapper = widget.closest('.sqs-code-block-wrapper');
                            if (wrapper) {
                                wrapper.style.position = 'relative';
                                wrapper.style.display = 'block';
                                wrapper.style.width = '100%';
                                wrapper.style.maxWidth = '450px';
                                wrapper.style.margin = '20px auto';
                            }
                        }
                        
                        // Watch for any changes Squarespace might make
                        const observer = new MutationObserver((mutations) => {
                            mutations.forEach((mutation) => {
                                if (mutation.type === 'childList') {
                                    const widget = document.getElementById('iqama-widget');
                                    if (widget && widget.parentElement !== targetContainer) {
                                        console.log('ðŸ”„ Widget moved, repositioning...');
                                        targetContainer.appendChild(widget);
                                        // Reapply minimal styles
                                        widget.style.position = 'relative';
                                        widget.style.display = 'block';
                                        widget.style.width = '100%';
                                        widget.style.maxWidth = '450px';
                                        widget.style.margin = '20px auto';
                                    }
                                }
                            });
                        });
                        
                        // Start observing
                        observer.observe(document.body, { childList: true, subtree: true });
                    }, 100);
                } else {
                    // Fallback: append to body but try to position it
                    document.body.appendChild(container);
                    console.log('âš ï¸ Widget appended to body - positioning manually');
                    
                    // Try to move it to a better position
                    const codeBlockArea = document.querySelector('.sqs-block.code-block');
                    if (codeBlockArea) {
                        const rect = codeBlockArea.getBoundingClientRect();
                        container.style.position = 'absolute';
                        container.style.top = rect.top + 'px';
                        container.style.left = rect.left + 'px';
                        container.style.width = rect.width + 'px';
                    }
                }

                // Auto-refresh every minute to update next prayer highlight
                setInterval(() => {
                    const widget = document.getElementById('iqama-widget');
                    if (widget) {
                        widget.remove();
                        createWidget();
                    }
                }, 60000);
                
                // Daily update at midnight to ensure current date and prayer times
                const now = new Date();
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0); // Set to midnight
                
                const timeUntilMidnight = tomorrow.getTime() - now.getTime();
                
                // Schedule daily update
                setTimeout(() => {
                    // Update every 24 hours (86400000 milliseconds)
                    setInterval(() => {
                        console.log('ðŸ”„ Daily update: Refreshing widget for new date');
                        const widget = document.getElementById('iqama-widget');
                        if (widget) {
                            widget.remove();
                            createWidget();
                        }
                    }, 86400000);
                    
                    // Initial daily update
                    console.log('ðŸ”„ Daily update: Refreshing widget for new date');
                    const widget = document.getElementById('iqama-widget');
                    if (widget) {
                        widget.remove();
                        createWidget();
                    }
                }, timeUntilMidnight);
            }

            // Initialize the widget by fetching data first
            fetchPrayerTimes();
        })();
    </script>
</body>
</html>
